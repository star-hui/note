# 1. linux基础篇

## 1.1. 系统性能命令相关

系统调优过程: cpu -> MeM -> Disk -> Network -> 应用程序  
主要是四大系统:

### 1.1.1. 找出cpu占用最多的

``` python
"1.找出系统cpu占用最多"
uptime 查看系统负载
 10:30:12 up 8 days,  1:54,  3 users,  load average: 4.14, 4.10, 4.12
现在时间     运行时长           用户        负载:       1m     5m   15m
经验值:cpu核数*3 < 负载值就正常。队列的长度，包含正在运行的

方法1:使用TOP命令，按下大写的P，就可以看到最多。实时的
方法2：ps aux --sort -pcpu | more 某一时刻的数据. pcpu能看到某一个的数据
```

### 1.1.2. 找出系统内存占用最多的

``` python
"# 2.找出系统内存占用最多"
方法1: top 按下 大写的M
方法2：ps aux --sort -rss | more 或 > a.log（重定向）
```

### 1.1.3. 找出磁盘读写最多的

``` python
"# 3.找出系统磁盘读写最多的进程"
dell@djz:~$ sudo apt-get install sysstat
dell@djz:~$ iostat -d -k -p /dev/sda
Linux 3.13.0-24-generic (djz.com)       2018年07月17日  _x86_64_        (20 CPU)

Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
sda               4.14         3.93       281.67    2756195  197440200
sda1              4.00         3.91       281.54    2741053  197352648
sda2              0.00         0.00         0.00         18          0
sda5              0.00         0.02         0.12      13728      87552
# sda1使用的比较多，使用df -h 查看具体的分区情况，sda1属于/分区，所有读写很多
dell@djz:~$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1       1.8T   69G  1.6T   5% /
none            4.0K     0  4.0K   0% /sys/fs/cgroup
udev             32G  4.0K   32G   1% /dev
tmpfs           6.3G  1.2M  6.3G   1% /run
none            5.0M     0  5.0M   0% /run/lock
none             32G  4.6M   32G   1% /run/shm
none            100M     0  100M   0% /run/user

# 当cpu不高，内存不高，网络也正常，但是服务器就是卡，如何解决。
# 一般就是磁盘问题了。找出系统中io最大的

iotop:
-o -only 只显示在读写硬盘的程序
-d       设定刷新间隔时间间隔
使用:iotop
```

### 1.1.4. 找出网络使用最多的

``` python
"4.查找网络使用最多的"
yum install epel  # 该包在epel下
yum install nload

nload 直接进入
ab -c 2 -n 1000 http://www.baidu.com/html  进行流量模拟


使用nethogs找出使用带宽最多的进程
yum install nethogs
使用： nethogs
wget进行测试就ok了、
```

## 1.2. 客户端dns设置

设置dns

``` sh
# 第一种方式,修改/etc/resolv.conf. 可以加多个DNS.
# 修改完直接生效。
[root@dns-client ~]# vim /etc/resolv.conf
# Generated by NetworkManager
nameserver      192.168.0.88
nameserver      223.5.5.5

# 第二种方式：修改网卡的配置文件,在最后加上DNS. 
# 重启网卡，其实也是生成resolve.conf
DNS1=192.168.0.88
[root@lh ~]# systemctl restart netwrok
[root@lh ~]# more /etc/resolv.conf
# Generated by NetworkManager
search cn
nameserver 192.168.0.88
```

## 系统安装完成的事情

``` python
# 1. 设置静态地址，dns，主机等
ls /etc/sysconfig/network-scripts/ifcfg-ens33     #IP地址，子网掩码等配置文件
ls /etc/sysconfig/network-scripts/ifcfg-lo 　　    #网卡回环地址
cat /etc/resolv.conf    　　　　　　　　　　　　　　   #DNS配置文件
cat /etc/hosts          　　　　　　　　　　　　　    #设置主机和IP绑定信息
cat /etc/hostname    　　　　　　　　　　　　　　　　  #设置主机名

# 2. 关闭SeLInux

临时关闭：
getenforce     #状态为enfocing，为打开
setenfoce   0  #状态为Permissive
永久关闭：
vim /etc/selinux/config  #直接修改配置文件 把enforing改成disabled

# 3. 更换yum源 以及安装epol源
yum 

# 3.更新软件包和系统内核
yum update


# 2. 应用部署

## 2.1. DNS服务器

> 资料地址: https://www.cnblogs.com/ityouknow/p/6380603.html  
> 使用服务: bind\tcpdump(抓包工具:  tcpdump -i ens33 -nn port 53 |tcpdump -i ens33 -nn host 192.168.1.2  )
### 2.1.1. DNS的基本概念

名字解析:  
1. NetBios名：tianyun  很早的使用 wins  
2. FQDN:完全限定域名(有完整的结构) www.tianyun.com.    hosts 与 dns server来提供查询。 
Fully Qualified Domain Name

无法记住ipv4地址，就使用了dns。最早的dns使用hosts文件来解析文件。随着互联网的快速发展已经淘汰了。 现在的hosts只是用来解析自己主机的解析和一些自己设定的简单解析。  

dns解析式层次化，分布式的。 从后往前解析www.baidu.com.  最后面其实是有个点。这个点就是根域。

### 2.1.2. DNS服务器cache only的使用

只进行转发和缓存，本地不做dns的解析。

1. 安装
    yum install -y bind （ --installroot=[path] 指定安装目录）  
    bind-utils(dig工具解析,检测使用)  dig == yum provides *bin/dig # 进行查询
2. 配置
    配置文件在/etc/named.conf
``` python
options {  #  修改这几样，基本就可以工作了。
        listen-on port 53 { 127.0.0.1; };  # 修改成any
        listen-on-v6 port 53 { ::1; };      # 修改成any
        directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
        forwrd             first;
        forwarders        {223.5.5.5;114.114.114.114;};
        for
        allow-query     { localhost; };    # 修改成any
}
```

配置文件说明, 就修改上面的any，就可以解析了，利用下面的配置段，直接去找跟。
``` python
zone "." IN {  #  跟提示区域，保存13台根域
        type hint;  # 根提示区域
        file "named.ca";  # 在文件开头directory中定义了
};
```

另外一种做法：在全局的options下配置fowads下配置一个转发，直接寻找上一级的供应商提供的dns
``` python
options {
    forwrd first;  #  又only和first两种方式。 first为优先去forwarders去查找，找不到则去根中查找。 only只会去forwaders去查找。
    forwarders {114.114.114.114;223.5.5.5;};
}
```

3. 第三步 关闭防火墙 与启动

``` python
iptable -F
systemctl start named  # 注意先要退出终端，重新进入一次
```

4. 自启动制作

> systemctrl enable named

### 2.1.3. 客户端指定dns

linux下

第一种方式: 在网卡的配置文件中加入dns
第二种在 vim /etc/resolv.conf 
> nameserver dns_ip

使用dig，ping等都可以，然后再服务器端抓包:

``` python
# 客户端
vim /etc resolv.conf
nameserver dns_ip

dig baidu.com

# 服务器
tcpdump -i ens33 -nn host 192.168.0.1
tcpdump -i ens33 -nn port 53
```

### 2.1.4. dns的正向区域

> 正向区域: 域名到ip的解析 [必须了解】  
> 反向区域: ip到域名的解析[了解就好，很少用]

配置正向区域只要两个步骤:
1. 在全局配置/etc/named.conf 中配置新的区域

``` python
zone "louhui.com" {  # 建立新的区域配置
        type    master;  # 属于主dns
        file    "louhui.com.zone"; # 配置文件，名字可以任意，但是最好是跟区域名字关联。 文件夹位置在options中默认定义。
};
```

2. 建立上一步的配置文件

``` python
louhui.me.		IN					SOA		dns.louhui.com.		roo.louhui.com.		(2017081800 1H 15M 1W 1D)
域名			代表internet		授权给	主机				有问题发邮件			主备之间同步的时间与版本

# 使用完全域名书写比较困难，同时存在一个容易忘记写根（.），我们可以使用@来代替域名。如下
```

使用@ 来代替域名，方便书写

``` python
                                        # 同步版本号:年月日-修正版本号。备份的小的就同步
                                        # 1H 代表 辅助dns的一次来同步一次
                                        # 15M  当和主服务器不能通讯，15分钟来重试一次
                                        # 当重试一周了，就放弃治疗
                                        # 缓存时间
$TTL 7200 # 有这个的时候，缓存以这个为准，无则以1D为准。
@       IN      SOA     dns     root    (2017081800 1H  15M 1W 1D)  # 起始授权-强制要写
@       IN      NS      dns                                         # DNS服务器记录 -强制要写
dns     IN      A       192.168.0.88
www     IN      A       192.168.0.222  # A记录，address
@       IN      A       192.168.0.222  # 给自己的域名直接解析

```

关于缓存时间：

``` python
三个地方设置:
    1. $TTL 7200(有这个，第二条不生效)
    2. 在同步中的最后一个参数
    3. 在每条记录中设置， www 与 IN之间的位置（优先级最高）
当从管理域拿到的时候时间就是设置时间
当从转发域拿到的时候时间就是 转发域剩下的时间.
```

### 2.1.5. 域名申请与使用

也是两个步骤，可以类比我们本地的建立:

1. 申请域名- 类比本地，建立一个正向区域
2. 解析域名-类比创建dns解析文件。在云端我们只要创建A记录就好了。

### 2.1.6. 客户端使用

#### 2.1.6.1. nslookup

``` python
# nslookup工具：
nslookup
baidu.com
set q=soa
baidu.com
set q=ns
baidu.com
server 8.8.8.8
set q=a  # 更改为a记录
baidu.com

# windowns客户端
 ipconfig /flushdns
 ipconfig /displaydns
```

#### 2.1.6.2. host 与 dig

``` python
host -t a www.baidu.com  # 正向解析，查询a记录，默认就是a记录。 -t a可以省略
host 192.168.0.88  # 反向解析
host -t soa baidu.com   # 查询某个域的授权
host -t ns  baidu.com   # 查询某个域的dns服务器
host -t mx  baidu.com   # 查询某个域的邮件服务器
dig www.baidu.com             # 使用/etc/resove.conf 的dns来查询
dig @192.168.1.1 www.126.com  # 指定dns来查询
```

### 2.1.7. dns查询过程整理

1. 先查找本地缓存,有直接使用(windows下hosts文件也是在缓存中的)
2. 查询本地的dns，如果是本地管理的域名主机，直接返回(有则返回记录，无则找不到)
3. 如果本地的dns，不是该域的管理者，则向上一级的发送请求。

这是比font标签更好的方式。可以试试。
