# 1. linux网络
## 1.1. dns相关

设置dns

``` sh
# 第一种方式,修改/etc/resolv.conf. 可以加多个DNS.
# 修改完直接生效。
[root@dns-client ~]# vim /etc/resolv.conf
# Generated by NetworkManager
nameserver      192.168.0.88
nameserver      223.5.5.5

# 第二种方式：修改网卡的配置文件,在最后加上DNS. 
# 重启网卡，其实也是生成resolve.conf
DNS1=192.168.0.88
[root@lh ~]# systemctl restart netwrok
[root@lh ~]# more /etc/resolv.conf
# Generated by NetworkManager
search cn
nameserver 192.168.0.88
```

# 2. 应用部署

## 2.1. DNS服务器

> 资料地址: https://www.cnblogs.com/ityouknow/p/6380603.html  
> 使用服务: bind\tcpdump(抓包工具:  tcpdump -i ens33 -nn port 53 |tcpdump -i ens33 -nn host 192.168.1.2  )
### 2.1.1. DNS的基本概念

名字解析:  
1. NetBios名：tianyun  很早的使用 wins  
2. FQDN:完全限定域名(有完整的结构) www.tianyun.com.    hosts 与 dns server来提供查询。 
Fully Qualified Domain Name

无法记住ipv4地址，就使用了dns。最早的dns使用hosts文件来解析文件。随着互联网的快速发展已经淘汰了。 现在的hosts只是用来解析自己主机的解析和一些自己设定的简单解析。  

dns解析式层次化，分布式的。 从后往前解析www.baidu.com.  最后面其实是有个点。这个点就是根域。

### 2.1.2. DNS服务器cache only的使用

1. 安装
    yum install -y bind （ --installroot=[path] 指定安装目录）  
    bind-utils(dig工具解析,检测使用)  dig == yum provides *bin/dig # 进行查询
2. 配置
    配置文件在/etc/named.conf
``` python
options {  #  修改这几样，基本就可以工作了。
        listen-on port 53 { 127.0.0.1; };  # 修改成any
        listen-on-v6 port 53 { ::1; };      # 修改成any
        directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
        allow-query     { localhost; };    # 修改成any
}
```

配置文件说明, 就修改上面的any，就可以解析了，利用下面的配置段，直接去找跟。
``` python
zone "." IN {  #  跟提示区域，保存13台根域
        type hint;  # 根提示区域
        file "named.ca";  # 在文件开头directory中定义了
};
```

另外一种做法：在全局的options下配置fowads下配置一个转发，直接寻找上一级的供应商提供的dns
``` python
options {
    forwrd first;  #  又only和first两种方式。 first为优先去forwarders去查找，找不到则去根中查找。 only只会去forwaders去查找。
    forwarders {114.114.114.114;223.5.5.5;};
}
```

3. 第三步 关闭防火墙 与启动

``` python
iptable -F
systemctl start named  # 注意先要退出终端，重新进入一次
```


### 2.1.3. 客户端的使用
linux下第一种方式: 在网卡的配置文件中加入dns
第二种在 vim /etc/resolv.conf 
> nameserver dns_ip

使用dig，ping等都可以，然后再服务器端抓包:

``` python
# 客户端
vim /etc resolv.conf
nameserver dns_ip

dig baidu.com

# 服务器
tcpdump -i ens33 -nn host 192.168.0.1
tcpdump -i ens33 -nn port 53
```

### 2.1.4. dns的正向区域

> 正向区域: 域名到ip的解析 [必须了解】  
> 反向区域: ip到域名的解析[了解就好，很少用]

配置正向区域只要两个步骤:
1. 在全局配置/etc/named.conf 中配置新的区域

``` python
zone "louhui.com" {  # 建立新的区域配置
        type    master;  # 属于主dns
        file    "louhui.com.zone"; # 配置文件，名字可以任意，但是最好是跟区域名字关联。 文件夹位置在options中默认定义。
};
```

2. 建立上一步的配置文件

``` python
louhui.me.		IN					SOA		dns.louhui.com.		roo.louhui.com.		(2017081800 1H 15M 1W 1D)
域名			代表internet		授权给	主机				有问题发邮件			主备之间同步的时间与版本

# 使用完全域名书写比较困难，同时存在一个容易忘记写根（.），我们可以使用@来代替域名。如下
```

使用@ 来代替域名，方便书写

``` python
                                        # 同步版本号:年月日-修正版本号。备份的小的就同步
                                        # 1H 代表 辅助dns的一次来同步一次
                                        # 15M  当和主服务器不能通讯，15分钟来重试一次
                                        # 当重试一周了，就放弃治疗
                                        # 缓存时间
$TTL 7200 # 有这个的时候，缓存以这个为准，无则以1D为准。
@       IN      SOA     dns     root    (2017081800 1H  15M 1W 1D)  # 起始授权-强制要写
@       IN      NS      dns                                         # DNS服务器记录 -强制要写
dns     IN      A       192.168.0.88
www     IN      A       192.168.0.222  # A记录，address
@       IN      A       192.168.0.222  # 给自己的域名直接解析

```

关于缓存时间：

``` python
三个地方设置:
    1. $TTL 7200(有这个，第二条不生效)
    2. 在同步中的最后一个参数
    3. 在每条记录中设置， www 与 IN之间的位置（优先级最高）
当从管理域拿到的时候时间就是设置时间
当从转发域拿到的时候时间就是 转发域剩下的时间.
```

### 2.1.5. 域名申请与使用

也是两个步骤，可以类比我们本地的建立:

1. 申请域名- 类比本地，建立一个正向区域
2. 解析域名-类比创建dns解析文件。在云端我们只要创建A记录就好了。

### 2.1.6. 客户端使用

#### 2.1.6.1. nslookup

``` python
# nslookup工具：
nslookup
baidu.com
set q=soa
baidu.com
set q=ns
baidu.com
server 8.8.8.8
set q=a  # 更改为a记录
baidu.com

# windowns客户端
 ipconfig /flushdns
 ipconfig /displaydns
```

#### 2.1.6.2. host 与 dig

``` python
host -t a www.baidu.com  # 正向解析，查询a记录，默认就是a记录。 -t a可以省略
host 192.168.0.88  # 反向解析
host -t soa baidu.com   # 查询某个域的授权
host -t ns  baidu.com   # 查询某个域的dns服务器
host -t mx  baidu.com   # 查询某个域的邮件服务器

dig www.baidu.com             # 使用/etc/resove.conf 的dns来查询
dig @192.168.1.1 www.126.com  # 指定dns来查询
```

### 2.1.7. dns查询过程整理

1. 先查找本地缓存,有直接使用(windows下hosts文件也是在缓存中的)
2. 查询本地的dns，如果是本地管理的域名主机，直接返回(有则返回记录，无则找不到)
3. 如果本地的dns，不是该主机的管理者，则向上一级的发送数据。